<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparktech AI Chatbot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            min-height: 100vh;
            color: #333;
        }
        .main-layout {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 260px;
            background: #23272f;
            color: #fff;
            display: flex;
            flex-direction: column;
            padding: 0;
            border-right: 1.5px solid #e0e0e0;
        }
        .sidebar-header {
            padding: 20px 16px 10px 16px;
            font-size: 1.3em;
            font-weight: bold;
            border-bottom: 1px solid #333;
            background: #181b20;
        }
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0 10px 0;
        }
        .history-item {
            padding: 10px 18px;
            cursor: pointer;
            border-bottom: 1px solid #2c2f36;
            color: #e0e0e0;
            transition: background 0.2s;
        }
        .history-item:hover {
            background: #31343b;
        }
        .container {
            flex: 1;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.5em;
            border-bottom: 1px solid #0056b3;
        }
        .user-profile {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .profile-menu {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 15px;
            min-width: 270px;
            z-index: 10;
        }
        .auth-section {
            padding: 15px;
        }
        .auth-section h2 {
            margin-top: 0;
            color: #007bff;
            text-align: center;
            font-size: 1.2em;
        }
        .profile-info {
            text-align: center;
            padding: 10px;
        }
        .profile-info p {
            margin: 0;
            font-weight: bold;
            color: #333;
        }
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 30px 40px 30px 40px;
            min-height: 0;
        }
        .chat-section h2 {
            margin-top: 0;
            color: #007bff;
            text-align: center;
        }
        input[type="text"],
        input[type="password"],
        input[type="email"],
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        button {
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .message.user {
            background-color: #d1e7dd;
            align-self: flex-end;
            text-align: right;
        }
        .message.bot {
            background-color: #f8d7da;
            align-self: flex-start;
            text-align: left;
        }
        .chat-display {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }
        #chat-input-area {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        #chat-input-area textarea {
            flex-grow: 1;
            margin-bottom: 0;
            resize: vertical;
            min-height: 40px;
        }
        #chat-input-area button {
            width: auto;
            min-width: 80px;
        }
        .error-message {
            color: red;
            font-size: 0.9em;
            text-align: center;
            margin-bottom: 10px;
        }
        .hidden {
            display: none;
        }
        @media (max-width: 900px) {
            .main-layout { flex-direction: column; }
            .sidebar { width: 100%; height: 180px; flex-direction: row; border-right: none; border-bottom: 1.5px solid #e0e0e0; }
            .container { height: calc(100vh - 180px); }
            .user-profile { top: 5px; right: 5px; width: 35px; height: 35px; }
            .profile-menu { top: 45px; min-width: 200px; right: 5px; }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <div class="sidebar">
            <div class="sidebar-header">History</div>
            <div class="history-list" id="history-list">
                <!-- Chat history items will be injected here -->
            </div>
        </div>
        <div class="container">
            <div class="header">Sparktech AI Chatbot</div>
            <div class="user-profile" id="user-profile">
                <span id="user-initial"></span>
                <div class="profile-menu" id="profile-menu">
                    <div id="auth-section" class="auth-section">
                        <h2 id="auth-mode">Register</h2>
                        <div class="error-message" id="auth-error"></div>
                        <input type="text" id="username" placeholder="Username">
                        <input type="email" id="email" placeholder="Email (optional)">
                        <input type="password" id="password" placeholder="Password">
                        <button id="auth-submit">Register</button>
                        <button id="toggle-auth-mode" class="toggle-btn">Switch to Login</button>
                    </div>
                    <div id="profile-info" class="profile-info hidden">
                        <p id="current-user"></p>
                        <button id="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
            <div id="chat-section" class="chat-section hidden">
                <h2>Chat with AI</h2>
                <div class="chat-display" id="chat-display"></div>
                <div id="chat-input-area">
                    <textarea id="user-query" placeholder="Type your message..."></textarea>
                    <button id="send-query">Send</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Set your Django API base URL here. It's the same origin now.
        const API_BASE_URL = '/api/'; 

        // Get DOM elements
        const userProfile = document.getElementById('user-profile');
        const userInitial = document.getElementById('user-initial');
        const profileMenu = document.getElementById('profile-menu');
        const authSection = document.getElementById('auth-section');
        const profileInfo = document.getElementById('profile-info');
        const authMode = document.getElementById('auth-mode');
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authSubmitBtn = document.getElementById('auth-submit');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
        const authErrorDiv = document.getElementById('auth-error');
        const currentUserSpan = document.getElementById('current-user');
        const logoutBtn = document.getElementById('logout-btn');
        const chatSection = document.getElementById('chat-section');
        const chatDisplay = document.getElementById('chat-display');
        const userQueryTextarea = document.getElementById('user-query');
        const sendQueryBtn = document.getElementById('send-query');

        let isLoginMode = false; // Tracks whether we are in login or register mode
        let chatHistoryCache = [];

        // --- Utility Functions ---

        function showAuthError(message) {
            authErrorDiv.textContent = message;
            authErrorDiv.classList.remove('hidden');
        }

        function clearAuthError() {
            authErrorDiv.textContent = '';
            authErrorDiv.classList.add('hidden');
        }

        function setAuthToken(token) {
            localStorage.setItem('access_token', token.access);
            localStorage.setItem('refresh_token', token.refresh);
        }

        function getAccessToken() {
            return localStorage.getItem('access_token');
        }

        function getRefreshToken() {
            return localStorage.getItem('refresh_token');
        }

        function clearAuthTokens() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
        }

        function appendMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            messageDiv.textContent = text;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
        }

        async function fetchWithAuth(url, options = {}) {
            const token = getAccessToken();
            if (token) {
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                };
            }
            const response = await fetch(url, options);
            if (response.status === 401 && getRefreshToken()) { // Token expired or invalid, try refreshing
                console.log("Access token expired, attempting to refresh...");
                const refreshSuccess = await refreshAccessToken();
                if (refreshSuccess) {
                    // Retry original request with new token
                    const newToken = getAccessToken();
                    options.headers = {
                        ...options.headers,
                        'Authorization': `Bearer ${newToken}`
                    };
                    return fetch(url, options);
                } else {
                    throw new Error("Failed to refresh token. Please log in again.");
                }
            }
            return response;
        }

        async function refreshAccessToken() {
            const refreshToken = getRefreshToken();
            if (!refreshToken) return false;

            try {
                const response = await fetch(`${API_BASE_URL}token/refresh/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh: refreshToken })
                });
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    return true;
                } else {
                    console.error("Refresh token failed:", await response.json());
                    clearAuthTokens();
                    return false;
                }
            } catch (error) {
                console.error("Error refreshing token:", error);
                clearAuthTokens();
                return false;
            }
        }

        // --- Authentication Logic ---

        async function handleAuthSubmit() {
            clearAuthError();
            const username = usernameInput.value;
            const password = passwordInput.value;
            const email = emailInput.value;

            if (!username || !password) {
                showAuthError("Username and password are required.");
                return;
            }

            let url = isLoginMode ? `${API_BASE_URL}token/` : `${API_BASE_URL}register/`;
            let body = { username, password };
            if (!isLoginMode && email) { // Add email only for registration if provided
                body.email = email;
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (response.ok) {
                    if (isLoginMode) {
                        setAuthToken(data); // Save access and refresh tokens
                        localStorage.setItem('username_for_display', username); // Store username for display
                        updateProfileUI(username);
                        showChatSection();
                        loadChatHistory();
                    } else {
                        alert("Registration successful! Please login.");
                        toggleAuthMode(); // Switch to login mode after successful registration
                    }
                } else {
                    // Display specific error messages from API
                    const errorMsg = data.detail || (data.username && `Username: ${data.username[0]}`) || (data.password && `Password: ${data.password[0]}`) || JSON.stringify(data);
                    showAuthError(errorMsg);
                }
            } catch (error) {
                console.error('Auth request failed:', error);
                showAuthError("Network error or API is unreachable.");
            }
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            authMode.textContent = isLoginMode ? "Login" : "Register";
            authSubmitBtn.textContent = isLoginMode ? "Login" : "Register";
            toggleAuthModeBtn.textContent = isLoginMode ? "Switch to Register" : "Switch to Login";
            emailInput.classList.toggle('hidden', isLoginMode); // Hide email for login
            clearAuthError();
            usernameInput.value = '';
            passwordInput.value = '';
            emailInput.value = '';
        }

        function updateProfileUI(username) {
            userInitial.textContent = username ? username[0].toUpperCase() : '';
            currentUserSpan.textContent = username || '';
            authSection.classList.add('hidden');
            profileInfo.classList.remove('hidden');
            profileMenu.style.display = 'none';
        }

        function showAuthSection() {
            userInitial.textContent = '';
            authSection.classList.remove('hidden');
            profileInfo.classList.add('hidden');
            chatSection.classList.add('hidden');
            clearAuthTokens();
            localStorage.removeItem('username_for_display'); // Clear stored username
            clearChatDisplay();
            isLoginMode = false; // Reset to register mode when showing auth
            toggleAuthMode(); // Toggle once to set to "Register" correctly
        }

        function showChatSection() {
            authSection.classList.add('hidden');
            profileInfo.classList.add('hidden');
            chatSection.classList.remove('hidden');
            profileMenu.style.display = 'none';
        }

        function clearChatDisplay() {
            chatDisplay.innerHTML = '';
        }

        async function logout() {
            showAuthSection();
            alert("You have been logged out.");
        }

        // --- Chat Logic ---

        async function sendQuery() {
            const query = userQueryTextarea.value.trim();
            if (!query) return;

            appendMessage('user', query);
            userQueryTextarea.value = ''; // Clear input

            try {
                const response = await fetchWithAuth(`${API_BASE_URL}chat/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });

                if (response.ok) {
                    const data = await response.json();
                    appendMessage('bot', data.bot_response);
                } else {
                    const errorData = await response.json();
                    appendMessage('bot', `Error: ${errorData.error || 'Failed to get response.'}`);
                }
            } catch (error) {
                console.error('Error sending query:', error);
                appendMessage('bot', `System Error: ${error.message || 'Could not connect to chatbot service.'}`);
                if (error.message.includes("Failed to refresh token")) {
                    showAuthSection(); // Force logout if token refresh fails
                    alert("Your session expired. Please log in again.");
                }
            }
        }

        async function loadChatHistory() {
            clearChatDisplay();
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}chat/history/`);
                if (response.ok) {
                    const history = await response.json();
                    chatHistoryCache = history;
                    renderHistorySidebar(history);
                    if (history.length === 0) {
                        appendMessage('bot', 'No chat history found. Start chatting!');
                    } else {
                        history.forEach(msg => {
                            appendMessage('user', msg.user_query);
                            appendMessage('bot', msg.bot_response);
                        });
                    }
                } else {
                    const errorData = await response.json();
                    appendMessage('bot', `Failed to load history: ${errorData.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                appendMessage('bot', `System Error: ${error.message || 'Could not load chat history.'}`);
                if (error.message.includes("Failed to refresh token")) {
                    showAuthSection(); // Force logout if token refresh fails
                    alert("Your session expired. Please log in again.");
                }
            }
        }

        // --- Event Listeners ---
        userProfile.addEventListener('click', () => {
            profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block';
        });

        authSubmitBtn.addEventListener('click', handleAuthSubmit);
        toggleAuthModeBtn.addEventListener('click', toggleAuthMode);
        logoutBtn.addEventListener('click', logout);
        sendQueryBtn.addEventListener('click', sendQuery);
        userQueryTextarea.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) { // Enter key without Shift
                event.preventDefault(); // Prevent new line
                sendQuery();
            }
        });

        // --- Initial Check on Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const storedUsername = localStorage.getItem('username_for_display');
            if (getAccessToken() && storedUsername) {
                updateProfileUI(storedUsername);
                showChatSection();
                loadChatHistory();
            } else {
                showAuthSection();
            }
        });

        // --- History Sidebar ---
        function renderHistorySidebar(history) {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            if (!history || history.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'history-item';
                emptyDiv.textContent = 'No history yet';
                historyList.appendChild(emptyDiv);
                return;
            }
            history.forEach((msg, idx) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.textContent = msg.user_query.length > 30 ? msg.user_query.slice(0, 30) + '...' : msg.user_query;
                item.title = msg.user_query;
                item.onclick = () => showSingleHistory(idx);
                historyList.appendChild(item);
            });
        }

        function showSingleHistory(idx) {
            clearChatDisplay();
            if (!chatHistoryCache[idx]) return;
            appendMessage('user', chatHistoryCache[idx].user_query);
            appendMessage('bot', chatHistoryCache[idx].bot_response);
        }
    </script>
</body>
</html>